<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="991px" height="842px" viewBox="-0.5 -0.5 991 842" content="&lt;mxfile host=&quot;Electron&quot; modified=&quot;2022-04-16T20:36:58.379Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 12_0_1) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/14.4.3 Chrome/87.0.4280.141 Electron/11.3.0 Safari/537.36&quot; etag=&quot;a65qqwv2ksebuQbR-5hV&quot; version=&quot;14.4.3&quot; type=&quot;device&quot;&gt;&lt;diagram id=&quot;3b20BdGqKjfSOICx5HSt&quot; name=&quot;Page-1&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;"><defs/><g><path d="M 430 60 L 430 103.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 430 108.88 L 426.5 101.88 L 430 103.63 L 433.5 101.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><rect x="370" y="0" width="120" height="60" rx="9" ry="9" fill="#d5e8d4" stroke="#82b366" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 30px; margin-left: 371px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">百万并发请求到来</div></div></div></foreignObject><text x="430" y="34" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">百万并发请求到来</text></switch></g><path d="M 510 10 L 510 43.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 510 48.88 L 506.5 41.88 L 510 43.63 L 513.5 41.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><path d="M 530 10 L 530 43.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 530 48.88 L 526.5 41.88 L 530 43.63 L 533.5 41.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><path d="M 550 10 L 550 43.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 550 48.88 L 546.5 41.88 L 550 43.63 L 553.5 41.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><path d="M 365 150 L 286.37 150" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 281.12 150 L 288.12 146.5 L 286.37 150 L 288.12 153.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 140px; margin-left: 325px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap; ">缓存命中</div></div></div></foreignObject><text x="325" y="144" fill="#000000" font-family="Helvetica" font-size="11px" text-anchor="middle">缓存命中</text></switch></g><path d="M 430 190 L 430 293.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 430 298.88 L 426.5 291.88 L 430 293.63 L 433.5 291.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 237px; margin-left: 431px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap; ">缓存未命中<br />要查数据库了</div></div></div></foreignObject><text x="431" y="240" fill="#000000" font-family="Helvetica" font-size="11px" text-anchor="middle">缓存未命中&#xa;要查数据库了</text></switch></g><path d="M 430 110 L 495 150 L 430 190 L 365 150 Z" fill="#f8cecc" stroke="#b85450" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 128px; height: 1px; padding-top: 150px; margin-left: 366px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">查询Redis缓存</div></div></div></foreignObject><text x="430" y="154" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">查询Redis缓存</text></switch></g><rect x="160" y="120" width="120" height="60" rx="9" ry="9" fill="#fff2cc" stroke="#d6b656" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 150px; margin-left: 161px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">返回缓存数据</div></div></div></foreignObject><text x="220" y="154" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">返回缓存数据</text></switch></g><path d="M 370 345 L 350 345 L 350 280 L 400 280 L 400 293.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 400 298.88 L 396.5 291.88 L 400 293.63 L 403.5 291.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><path d="M 430 360 L 430 403.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 430 408.88 L 426.5 401.88 L 430 403.63 L 433.5 401.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 385px; margin-left: 430px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap; ">成功</div></div></div></foreignObject><text x="430" y="388" fill="#000000" font-family="Helvetica" font-size="11px" text-anchor="middle">成功</text></switch></g><rect x="370" y="300" width="120" height="60" rx="9" ry="9" fill="#fff2cc" stroke="#d6b656" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 330px; margin-left: 371px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">获取Redis分布式锁<br />并设置过期时间</div></div></div></foreignObject><text x="430" y="334" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">获取Redis分布式锁...</text></switch></g><rect x="510" y="295" width="480" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 478px; height: 1px; padding-top: 305px; margin-left: 512px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">这里加锁是为了避免「缓存击穿」<br />（如果key在大量请求进来前正好失效，那所有的查询落到了数据库里）</div></div></div></foreignObject><text x="512" y="309" fill="#000000" font-family="Helvetica" font-size="12px">这里加锁是为了避免「缓存击穿」&#xa;（如果key在大量请求进来前正好失效，那所有的查询落到了数据库里）</text></switch></g><rect x="240" y="290" width="110" height="50" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 315px; margin-left: 295px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">未获取锁成功，<br />线程休眠200ms后<br />重试自旋获取锁</div></div></div></foreignObject><text x="295" y="319" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">未获取锁成功，线程休眠200ms后...</text></switch></g><path d="M 370 450 L 286.37 450" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 281.12 450 L 288.12 446.5 L 286.37 450 L 288.12 453.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><path d="M 430 490 L 430 533.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 430 538.88 L 426.5 531.88 L 430 533.63 L 433.5 531.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 515px; margin-left: 430px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap; ">缓存未命中</div></div></div></foreignObject><text x="430" y="518" fill="#000000" font-family="Helvetica" font-size="11px" text-anchor="middle">缓存未命中</text></switch></g><path d="M 430 410 L 490 450 L 430 490 L 370 450 Z" fill="#f8cecc" stroke="#b85450" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 450px; margin-left: 371px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">查询Redis缓存</div></div></div></foreignObject><text x="430" y="454" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">查询Redis缓存</text></switch></g><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 440px; margin-left: 325px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap; ">缓存命中</div></div></div></foreignObject><text x="325" y="444" fill="#000000" font-family="Helvetica" font-size="11px" text-anchor="middle">缓存命中</text></switch></g><rect x="160" y="420" width="120" height="60" rx="9" ry="9" fill="#fff2cc" stroke="#d6b656" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 450px; margin-left: 161px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">返回缓存数据</div></div></div></foreignObject><text x="220" y="454" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">返回缓存数据</text></switch></g><rect x="510" y="400" width="360" height="100" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 1px; height: 1px; padding-top: 450px; margin-left: 512px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">这里多一次查询Redis缓存的原因是<br /><div><span>设想个场景：</span></div><div>第一个和第二个线程都因为没读到缓存同时竞争分布式锁，</div><div>第一个线程获取到了锁，第二个线程没有，在等待重试自选获取锁</div><div>这时候第一个线程查好数据库、放入缓存、释放锁、返回了</div><div>这时候第二个线程获取到了锁，就不应该再查数据库了</div><div>所以这时候应该再查下Redis缓存，有数据就直接返回</div></div></div></div></foreignObject><text x="512" y="454" fill="#000000" font-family="Helvetica" font-size="12px">这里多一次查询Redis缓存的原因是...</text></switch></g><path d="M 430 600 L 430 653.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 430 658.88 L 426.5 651.88 L 430 653.63 L 433.5 651.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><rect x="370" y="540" width="120" height="60" rx="9" ry="9" fill="#fff2cc" stroke="#d6b656" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 570px; margin-left: 371px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">查询数据库<br />并存入Redis缓存</div></div></div></foreignObject><text x="430" y="574" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">查询数据库&#xa;并存入Redis缓存</text></switch></g><rect x="370" y="660" width="120" height="60" rx="9" ry="9" fill="#d5e8d4" stroke="#82b366" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 690px; margin-left: 371px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">无论是否抛异常<br />最后都要释放锁</div></div></div></foreignObject><text x="430" y="694" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">无论是否抛异常&#xa;最后都要释放锁</text></switch></g><path d="M 160 360 L 155 360 Q 150 360 150 370 L 150 500 Q 150 510 145 510 L 142.5 510 Q 140 510 145 510 L 147.5 510 Q 150 510 150 520 L 150 650 Q 150 660 155 660 L 160 660" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><rect x="0" y="495" width="150" height="30" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 510px; margin-left: 75px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">临界区<br />同时只有一个线程在执行</div></div></div></foreignObject><text x="75" y="514" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">临界区&#xa;同时只有一个线程在执行</text></switch></g><rect x="500" y="545" width="400" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 555px; margin-left: 700px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">目的：只要整个流程第一次缓存查询没命中，只有一个线程能查询数据库</div></div></div></foreignObject><text x="700" y="559" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">目的：只要整个流程第一次缓存查询没命中，只有一个线程能查询数据库</text></switch></g><rect x="100" y="760" width="710" height="80" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 1px; height: 1px; padding-top: 800px; margin-left: 102px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">加锁<br />setnx("lock", xxx)：只有key不存在时候能设置占用，否则不行<br />setnx ex 设置过期时间：业务代码异常或者程序在页面过程 中宕机。没有执行删除锁逻辑，这就造成了死锁，所以要给锁加过期时间<br />设置锁是需要原子性的，这是为了怕加锁和设置过期时间中间断电宕机了，这样又死锁无法释放了<br />有时候业务代码执行很长时间，超过了锁的过期时间，为了删锁时候不要删了别人的，需要加锁时指定值为uuid，只能删自己的锁</div></div></div></foreignObject><text x="102" y="804" fill="#000000" font-family="Helvetica" font-size="12px">加锁setnx("lock", xxx)：只有key不存在时候能设置占用，否则不行...</text></switch></g><rect x="510" y="665" width="460" height="50" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 1px; height: 1px; padding-top: 690px; margin-left: 512px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">删锁<br />删锁时候不要删了别人的，要删自己的锁，所以需要加锁时要对比锁value，再去删锁<br />设置锁是需要原子性的，用Redis lua脚本来保证</div></div></div></foreignObject><text x="512" y="694" fill="#000000" font-family="Helvetica" font-size="12px">删锁删锁时候不要删了别人的，要删自己的锁，所以需要加锁时要对比锁value，再去删锁...</text></switch></g><rect x="510" y="730" width="240" height="30" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 1px; height: 1px; padding-top: 745px; margin-left: 512px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">原子性：<br />多条指令要么全部执行，要么全不执行回滚</div></div></div></foreignObject><text x="512" y="749" fill="#000000" font-family="Helvetica" font-size="12px">原子性：&#xa;多条指令要么全部执行，要么全不执行回滚</text></switch></g><rect x="510" y="335" width="410" height="30" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 1px; height: 1px; padding-top: 350px; margin-left: 512px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">可能代码执行时间太长，锁都自动释放了，所以锁的过期时间放长点，30s<br />同时过期时间要设置随机性，这是为了避免「缓存雪崩」</div></div></div></foreignObject><text x="512" y="354" fill="#000000" font-family="Helvetica" font-size="12px">可能代码执行时间太长，锁都自动释放了，所以锁的过期时间放长点，30s...</text></switch></g><rect x="500" y="575" width="460" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 585px; margin-left: 730px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">这里查询数据库如果没有数据的话，也给Redis缓存存个null，这是避免「缓存穿透」</div></div></div></foreignObject><text x="730" y="589" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">这里查询数据库如果没有数据的话，也给Redis缓存存个null，这是避免「缓存穿透」</text></switch></g><path d="M 120 750 L 360 360" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" stroke-dasharray="2 6" pointer-events="stroke"/></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://www.diagrams.net/doc/faq/svg-export-text-problems" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Viewer does not support full SVG 1.1</text></a></switch></svg>